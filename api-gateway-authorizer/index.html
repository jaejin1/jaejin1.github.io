<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>API Gateway Authorizer - </title><meta name="Description" content="This is jaejin&#39;s blog"><meta property="og:title" content="API Gateway Authorizer" />
<meta property="og:description" content="AWS Lambda로 끄적이다가 API Gateway를 붙여보자! 해서 보던 중 API Gateway는 인증 및 권한부여 기능을 제공 해주고 있었고 그 중 Authorizers의 존재를 봐서 api를 위한 Lambda 호출 전에 인증을 위한 Lambda를 호출 하는 것을 구성해봤다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/api-gateway-authorizer/" />
<meta property="og:image" content="http://example.org/images/jaejin.png"/>
<meta property="article:published_time" content="2023-02-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://example.org/images/jaejin.png"/>

<meta name="twitter:title" content="API Gateway Authorizer"/>
<meta name="twitter:description" content="AWS Lambda로 끄적이다가 API Gateway를 붙여보자! 해서 보던 중 API Gateway는 인증 및 권한부여 기능을 제공 해주고 있었고 그 중 Authorizers의 존재를 봐서 api를 위한 Lambda 호출 전에 인증을 위한 Lambda를 호출 하는 것을 구성해봤다."/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/api-gateway-authorizer/" /><link rel="prev" href="http://example.org/jwt-signing-using-aws-kms/" /><link rel="next" href="http://example.org/letter-combinations-of-a-phone-number/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "API Gateway Authorizer",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/api-gateway-authorizer\/"
        },"genre": "posts","keywords": "cloud, aws, apigateway","wordcount":  770 ,
        "url": "http:\/\/example.org\/api-gateway-authorizer\/","datePublished": "2023-02-05T00:00:00+00:00","dateModified": "2023-02-05T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Jaejin"
            },"description": ""
    }
    </script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9014417707535100"
     crossorigin="anonymous"></script>
    </head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="">Jaejin&#39;s blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> Posts </a><a class="menu-item" href="/tags/"> Tags </a><a class="menu-item" href="/categories/"> Categories </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="">Jaejin&#39;s blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a class="menu-item" href="/about/" title="">About</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">API Gateway Authorizer</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://jaejin1.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Jaejin</a></span>&nbsp;<span class="post-category">included in <a href="/categories/aws/"><i class="far fa-folder fa-fw"></i>aws</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2023-02-05">2023-02-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;770 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#api-gateway-authorizer">API Gateway authorizer</a>
          <ul>
            <li><a href="#authorizer-워크-플로우">authorizer 워크 플로우</a></li>
          </ul>
        </li>
        <li><a href="#authorizer">authorizer</a>
          <ul>
            <li><a href="#lambda-function">lambda function</a></li>
            <li><a href="#구성">구성</a></li>
            <li><a href="#결과">결과</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>AWS Lambda로 끄적이다가 API Gateway를 붙여보자! 해서 보던 중 API Gateway는 인증 및 권한부여 기능을 제공 해주고 있었고 그 중 Authorizers의 존재를 봐서 api를 위한 Lambda 호출 전에 인증을 위한 Lambda를 호출 하는 것을 구성해봤다.</p>
<h3 id="api-gateway-authorizer">API Gateway authorizer</h3>
<p>먼저 API Gateway는 요청에 대한 인증을 처리하기 위한 방법이 크게 2가지가 있다고 한다.</p>
<ul>
<li>authorizer lambda function 이용
<ul>
<li>token 기반</li>
<li>request 기반</li>
</ul>
</li>
<li>AWS Cognito를 이용하여 인증</li>
</ul>
<p>cognito는 간단하게 써보기 위해서 굳이 사용하진 않을거고 lambda를 이용해보려고 한다.</p>
<p>token과 reuqest 차이는 authorizer lambda function에서 받는 <code>event 정보</code> 차이 이다.</p>
<ul>
<li>token은 Authorization 정보만 event.AuthorizationToken으로 값이 들어오고</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">APIGatewayCustomAuthorizerRequest</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Type</span>               <span class="kt">string</span> <span class="s">`json:&#34;type&#34;`</span>
	<span class="nx">AuthorizationToken</span> <span class="kt">string</span> <span class="s">`json:&#34;authorizationToken&#34;`</span>
	<span class="nx">MethodArn</span>          <span class="kt">string</span> <span class="s">`json:&#34;methodArn&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>request는 HTTP header, pathParam, queryString등 여러가지 정보를 받을 수 있다. 즉 HTTP 요청 정보를 세세히 받을 수 있다고 보면 된다.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">APIGatewayCustomAuthorizerRequestTypeRequest</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Type</span>                            <span class="kt">string</span>                                              <span class="s">`json:&#34;type&#34;`</span>
	<span class="nx">MethodArn</span>                       <span class="kt">string</span>                                              <span class="s">`json:&#34;methodArn&#34;`</span> <span class="c1">//nolint: stylecheck
</span><span class="c1"></span>	<span class="nx">Resource</span>                        <span class="kt">string</span>                                              <span class="s">`json:&#34;resource&#34;`</span>
	<span class="nx">Path</span>                            <span class="kt">string</span>                                              <span class="s">`json:&#34;path&#34;`</span>
	<span class="nx">HTTPMethod</span>                      <span class="kt">string</span>                                              <span class="s">`json:&#34;httpMethod&#34;`</span>
	<span class="nx">Headers</span>                         <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>                                   <span class="s">`json:&#34;headers&#34;`</span>
	<span class="nx">MultiValueHeaders</span>               <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">string</span>                                 <span class="s">`json:&#34;multiValueHeaders&#34;`</span>
	<span class="nx">QueryStringParameters</span>           <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>                                   <span class="s">`json:&#34;queryStringParameters&#34;`</span>
	<span class="nx">MultiValueQueryStringParameters</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">string</span>                                 <span class="s">`json:&#34;multiValueQueryStringParameters&#34;`</span>
	<span class="nx">PathParameters</span>                  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>                                   <span class="s">`json:&#34;pathParameters&#34;`</span>
	<span class="nx">StageVariables</span>                  <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>                                   <span class="s">`json:&#34;stageVariables&#34;`</span>
	<span class="nx">RequestContext</span>                  <span class="nx">APIGatewayCustomAuthorizerRequestTypeRequestContext</span> <span class="s">`json:&#34;requestContext&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>일반적으로 많이사용하는 JWT인증의 경우 token 기반 인증으로도 충분하기 때문에 token 기반 인증으로 구성하고 사용해보려 한다.</p>
<h4 id="authorizer-워크-플로우">authorizer 워크 플로우</h4>
<p>AWS 공식 문서의 인증 워크플로우 그림을 보자.</p>
<p><figure><a class="lightgallery" href="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/images/custom-auth-workflow.png" title="auth workflow" data-thumbnail="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/images/custom-auth-workflow.png" data-sub-html="<h2>auth workflow</h2><p>auth workflow</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/images/custom-auth-workflow.png"
            data-srcset="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/images/custom-auth-workflow.png, https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/images/custom-auth-workflow.png 1.5x, https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/images/custom-auth-workflow.png 2x"
            data-sizes="auto"
            alt="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/images/custom-auth-workflow.png" />
    </a><figcaption class="image-caption">auth workflow</figcaption>
    </figure></p>
<ol>
<li>클라이언트가 요청을 보낼 때 token이나 request 파라미터 전달하고 API Gateway에서는 Lambda authorizer가 구성되어 있는지 확인한다.</li>
<li>authorizer가 Allow, Deny 여부를 판단해서 policy document를 반환한다.</li>
<li>Deny면 API Gateway에서 403을 반환하고 Allow면 각 method에 연결되어있는 서비스를 실행한다. 이때 authorizer의 cache 설정이 활성화 되어있다면 authorizer를 다시 실행하지 않도록 caching하여 비용을 절감할 수 있다.</li>
</ol>
<h3 id="authorizer">authorizer</h3>
<h4 id="lambda-function">lambda function</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">lambda</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">authorizerRequest</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">authorizerRequest</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">event</span> <span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerRequest</span><span class="p">)</span> <span class="p">(</span><span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 인증 처리
</span><span class="c1"></span>    <span class="c1">// ...
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">allow</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">generatePolicy</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">,</span> <span class="s">&#34;Allow&#34;</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">MethodArn</span><span class="p">),</span> <span class="kc">nil</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">generatePolicy</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">,</span> <span class="s">&#34;Deny&#34;</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">MethodArn</span><span class="p">),</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">generatePolicy</span><span class="p">(</span><span class="nx">principalId</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">resource</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerResponse</span> <span class="p">{</span>
	<span class="nx">authResponse</span> <span class="o">:=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerResponse</span><span class="p">{</span><span class="nx">PrincipalID</span><span class="p">:</span> <span class="nx">principalId</span><span class="p">}</span>

	<span class="k">if</span> <span class="nx">effect</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">resource</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">authResponse</span><span class="p">.</span><span class="nx">PolicyDocument</span> <span class="p">=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerPolicy</span><span class="p">{</span>
			<span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;2012-10-17&#34;</span><span class="p">,</span>
			<span class="nx">Statement</span><span class="p">:</span> <span class="p">[]</span><span class="nx">events</span><span class="p">.</span><span class="nx">IAMPolicyStatement</span><span class="p">{</span>
				<span class="p">{</span>
					<span class="nx">Action</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;execute-api:Invoke&#34;</span><span class="p">},</span>
					<span class="nx">Effect</span><span class="p">:</span>   <span class="nx">effect</span><span class="p">,</span>
					<span class="nx">Resource</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">resource</span><span class="p">},</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// Optional output with custom properties of the String, Number or Boolean type.
</span><span class="c1"></span>	<span class="nx">authResponse</span><span class="p">.</span><span class="nx">Context</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
		<span class="s">&#34;stringKey&#34;</span><span class="p">:</span>  <span class="s">&#34;stringval&#34;</span><span class="p">,</span>
		<span class="s">&#34;numberKey&#34;</span><span class="p">:</span>  <span class="mi">123</span><span class="p">,</span>
		<span class="s">&#34;booleanKey&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">authResponse</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>구성했던 전체 코드는 아니고 일부 코드이다. 인증로직은 JWT를 사용한다면 token 유효성 검사를 하는 부분 key file로 하거나 AWS KMS를 사용해서 유효하는지등의 작업을 하고 token이 정상적이라면 generatePolicy function에 ALLOW값을 넘겨주고 그게 아니라면 DENY를 넘겨서 return되게 구성했다.</p>
<p>token의 유효성에 따라 IAM Policy를 생성하면 된다. 이 때 resource에는 요청온 resource arn을 그대로 넣어주고 있는데, 여러개의 api를 사용하고 cache를 이용할 시 Resource 권한 문제로 이슈가 발생할 수 있으니 주의하자.</p>
<p>방법은 간단히 요청으로 받은 resource가 아닌 범위로 설정하여 return하면 될 것이다.</p>
<p>참고로 token기반이 아닌 request기반은 다음과 같이 처리 할 수 있다.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ValidateToken</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

	<span class="nx">apiGatewayProxyRequestContext</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">core</span><span class="p">.</span><span class="nf">GetAPIGatewayContextFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">apiGatewayProxyRequestContext</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">region</span> <span class="o">:=</span> <span class="s">&#34;ap-northeast-2&#34;</span>
	<span class="nx">effect</span> <span class="o">:=</span> <span class="s">&#34;Allow&#34;</span>
	<span class="nx">principalId</span> <span class="o">:=</span> <span class="s">&#34;user&#34;</span>
	<span class="nx">resource</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;arn:aws:execute-api:%s:%s:%s/%s/%s/%s&#34;</span><span class="p">,</span>
		<span class="nx">region</span><span class="p">,</span>
		<span class="nx">apiGatewayProxyRequestContext</span><span class="p">.</span><span class="nx">AccountID</span><span class="p">,</span>
		<span class="nx">apiGatewayProxyRequestContext</span><span class="p">.</span><span class="nx">APIID</span><span class="p">,</span>
		<span class="nx">apiGatewayProxyRequestContext</span><span class="p">.</span><span class="nx">Stage</span><span class="p">,</span>
		<span class="nx">apiGatewayProxyRequestContext</span><span class="p">.</span><span class="nx">HTTPMethod</span><span class="p">,</span>
		<span class="s">&#34;&#34;</span><span class="p">)</span>

	<span class="nx">authResponse</span> <span class="o">:=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerResponse</span><span class="p">{</span><span class="nx">PrincipalID</span><span class="p">:</span> <span class="nx">principalId</span><span class="p">}</span>

	<span class="k">if</span> <span class="nx">resource</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">authResponse</span><span class="p">.</span><span class="nx">PolicyDocument</span> <span class="p">=</span> <span class="nx">events</span><span class="p">.</span><span class="nx">APIGatewayCustomAuthorizerPolicy</span><span class="p">{</span>
			<span class="nx">Version</span><span class="p">:</span> <span class="s">&#34;2012-10-17&#34;</span><span class="p">,</span>
			<span class="nx">Statement</span><span class="p">:</span> <span class="p">[]</span><span class="nx">events</span><span class="p">.</span><span class="nx">IAMPolicyStatement</span><span class="p">{</span>
				<span class="p">{</span>
					<span class="nx">Action</span><span class="p">:</span>   <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;execute-api:Invoke&#34;</span><span class="p">},</span>
					<span class="nx">Effect</span><span class="p">:</span>   <span class="nx">effect</span><span class="p">,</span>
					<span class="nx">Resource</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">resource</span><span class="p">},</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// Optional output with custom properties of the String, Number or Boolean type.
</span><span class="c1"></span>	<span class="nx">authResponse</span><span class="p">.</span><span class="nx">Context</span> <span class="p">=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
		<span class="s">&#34;stringKey&#34;</span><span class="p">:</span>  <span class="s">&#34;stringval&#34;</span><span class="p">,</span>
		<span class="s">&#34;numberKey&#34;</span><span class="p">:</span>  <span class="mi">123</span><span class="p">,</span>
		<span class="s">&#34;booleanKey&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">authResponse</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="구성">구성</h4>
<p>이제 lambda는 위에 처럼 생성을 미리 해놓고 API Gateway의 authorizers를 설정해보자.</p>
<p><figure><a class="lightgallery" href="/api-gateway-authorizer/authorizer.png" title="authorizer" data-thumbnail="/api-gateway-authorizer/authorizer.png" data-sub-html="<h2>authorizer</h2><p>authorizer</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="authorizer.png"
            data-srcset="/api-gateway-authorizer/authorizer.png, authorizer.png 1.5x, /api-gateway-authorizer/authorizer.png 2x"
            data-sizes="auto"
            alt="/api-gateway-authorizer/authorizer.png" />
    </a><figcaption class="image-caption">authorizer</figcaption>
    </figure></p>
<p>Token방식으로 설정하고, Source는 <code>Authorization</code>으로 했다.</p>
<p><figure><a class="lightgallery" href="/api-gateway-authorizer/settingAuthorizer.png" title="authorizer" data-thumbnail="/api-gateway-authorizer/settingAuthorizer.png" data-sub-html="<h2>authorizer</h2><p>authorizer</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="settingAuthorizer.png"
            data-srcset="/api-gateway-authorizer/settingAuthorizer.png, settingAuthorizer.png 1.5x, /api-gateway-authorizer/settingAuthorizer.png 2x"
            data-sizes="auto"
            alt="/api-gateway-authorizer/settingAuthorizer.png" />
    </a><figcaption class="image-caption">authorizer</figcaption>
    </figure></p>
<p>api 호출시 인증이 필요한 method에 Authorization 설정을 생성한 것으로 설정한다.</p>
<h4 id="결과">결과</h4>
<p>이제 api 호출을 해보자.</p>
<p><figure><a class="lightgallery" href="/api-gateway-authorizer/unauthorized.png" title="unauthorized" data-thumbnail="/api-gateway-authorizer/unauthorized.png" data-sub-html="<h2>unauthorized</h2><p>unauthorized</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="unauthorized.png"
            data-srcset="/api-gateway-authorizer/unauthorized.png, unauthorized.png 1.5x, /api-gateway-authorizer/unauthorized.png 2x"
            data-sizes="auto"
            alt="/api-gateway-authorizer/unauthorized.png" />
    </a><figcaption class="image-caption">unauthorized</figcaption>
    </figure></p>
<p>auth값을 아무것도 넣어주지 않았을 때 API Gateway에서 401을 뱉고 있는 것을 볼 수 있다.</p>
<p><figure><a class="lightgallery" href="/api-gateway-authorizer/allow.png" title="allow" data-thumbnail="/api-gateway-authorizer/allow.png" data-sub-html="<h2>allow</h2><p>allow</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="allow.png"
            data-srcset="/api-gateway-authorizer/allow.png, allow.png 1.5x, /api-gateway-authorizer/allow.png 2x"
            data-sizes="auto"
            alt="/api-gateway-authorizer/allow.png" />
    </a><figcaption class="image-caption">allow</figcaption>
    </figure></p>
<p>유효한 token을 넣어주고 authorizer lambda function에서 ALLOW를 넘겨줬다면? 요청한 Method가 정상적으로 호출 된 것을 볼 수 있다.</p>
<p>만약 token값이 유효하지 않아서 DENY를 return했다면?</p>
<p><figure><a class="lightgallery" href="/api-gateway-authorizer/deny.png" title="deny" data-thumbnail="/api-gateway-authorizer/deny.png" data-sub-html="<h2>deny</h2><p>deny</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="deny.png"
            data-srcset="/api-gateway-authorizer/deny.png, deny.png 1.5x, /api-gateway-authorizer/deny.png 2x"
            data-sizes="auto"
            alt="/api-gateway-authorizer/deny.png" />
    </a><figcaption class="image-caption">deny</figcaption>
    </figure></p>
<p>API Gateway 403과 함께 deny된 메세지가 출력된다.</p>
<p>간단히 사용을 해보았는데 Lambda로 API구성을 한번 해보고 싶어서 어찌저찌 API Gateway까지 건들게 되서 authorizer를 사용해봤다.</p>
<p>기능적으로는 ELB뒤에 Lambda를 붙이는 것보다 API Gateway가 기능적으로 인증 및 권한과 요청 및 응답 매핑 정도가 있을 것 같은데 비용도 비싸기도 하고.. 실제 운영 환경에 적용할 때는 여러가지로 확인이 필요할듯 하다.</p>
<p>참고 할만한 페이지 <a href="https://serverless-training.com/articles/api-gateway-vs-application-load-balancer-technical-details/">https://serverless-training.com/articles/api-gateway-vs-application-load-balancer-technical-details/</a></p>
<hr>
<p><strong>참고</strong></p>
<ul>
<li><a href="https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html">https://docs.aws.amazon.com/ko_kr/apigateway/latest/developerguide/apigateway-use-lambda-authorizer.html</a></li>
<li><a href="https://lacti.github.io/2019/08/01/api-gateway-custom-authorizer/">https://lacti.github.io/2019/08/01/api-gateway-custom-authorizer/</a></li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-02-05</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/api-gateway-authorizer/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://example.org/api-gateway-authorizer/" data-title="API Gateway Authorizer" data-hashtags="cloud,aws,apigateway"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/api-gateway-authorizer/" data-hashtag="cloud"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="http://example.org/api-gateway-authorizer/"><i class="fab fa-linkedin fa-fw"></i></a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="http://example.org/api-gateway-authorizer/" data-title="API Gateway Authorizer" data-web><i class="fab fa-whatsapp fa-fw"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/api-gateway-authorizer/" data-title="API Gateway Authorizer"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="http://example.org/api-gateway-authorizer/" data-title="API Gateway Authorizer"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/cloud/">cloud</a>,&nbsp;<a href="/tags/aws/">aws</a>,&nbsp;<a href="/tags/apigateway/">apigateway</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/jwt-signing-using-aws-kms/" class="prev" rel="prev" title="JWT signing using AWS KMS"><i class="fas fa-angle-left fa-fw"></i>JWT signing using AWS KMS</a>
            <a href="/letter-combinations-of-a-phone-number/" class="next" rel="next" title="[Leetcode] 17. Letter Combinations of a Phone Number">[Leetcode] 17. Letter Combinations of a Phone Number<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.80.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">jaejin</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><script type="text/javascript" src="https://https-jaejin1-github-io.disqus.com/embed.js" defer></script><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":100},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
